<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Meta balises pour le mode Web App (PWA) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ifta Smart">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0A0F12">

    <!-- Icônes pour iPhone/Android (utilisant un favicon d'exemple) -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2800/2800045.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2800/2800045.png">

    <!-- Lien vers le manifest (voir instructions ci-dessous pour le créer sur GitHub) -->
    <link rel="manifest" href="manifest.json">

    <title>Al-Ifta Smart Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-emerald: #00A67E;
            --secondary-gold: #D4AF37;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --surface-dark: #0A0F12;
            --accent-glow: rgba(0, 166, 126, 0.15);
        }

        html, body {
            height: 100dvh;
            margin: 0;
            overflow: hidden;
            background-color: var(--surface-dark);
            font-family: 'Plus Jakarta Sans', sans-serif;
            display: flex;
            flex-direction: column;
        }

        .bg-mesh {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 166, 126, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(212, 175, 55, 0.05) 0%, transparent 40%);
            z-index: -1;
        }

        .glass-panel {
            background: rgba(15, 23, 28, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .arabic-text {
            font-family: 'Amiri', serif;
            font-size: 1.5rem;
            line-height: 1.9;
            direction: rtl;
            display: block;
            margin: 1rem 0;
            color: #E2E8F0;
            text-align: right;
            padding: 1rem;
            background: rgba(0, 166, 126, 0.05);
            border-radius: 12px;
            border-right: 4px solid var(--primary-emerald);
        }

        .user-bubble {
            background: linear-gradient(135deg, var(--primary-emerald), #008162);
            color: white;
            border-radius: 18px 18px 2px 18px;
            box-shadow: 0 4px 15px rgba(0, 166, 126, 0.2);
        }

        .bot-bubble {
            background: rgba(255, 255, 255, 0.05);
            color: #F8FAFC;
            border-radius: 18px 18px 18px 2px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .smart-input {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .smart-input:focus {
            background: rgba(255, 255, 255, 0.06);
            border-color: var(--primary-emerald);
            box-shadow: 0 0 20px var(--accent-glow);
            outline: none;
        }

        #chat-window::-webkit-scrollbar { width: 5px; }
        #chat-window::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .float-icon { animation: float 6s ease-in-out infinite; }
        
        #chat-window {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="antialiased">

    <div class="bg-mesh"></div>

    <header class="py-4 md:py-6 px-4 md:px-8 flex-shrink-0 z-50">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3 md:gap-4">
                <div class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-tr from-[#00A67E] to-[#D4AF37] rounded-xl md:rounded-2xl flex items-center justify-center shadow-lg transform rotate-3">
                    <i class="fas fa-compass text-white text-lg md:text-xl"></i>
                </div>
                <div>
                    <h1 class="text-white text-lg md:text-xl font-bold tracking-tight">Ifta <span class="text-emerald-400 font-light">Intelligence</span></h1>
                    <p class="text-[8px] md:text-[10px] text-emerald-500/60 uppercase font-semibold tracking-[0.2em]">Saudi Digital Guidance</p>
                </div>
            </div>
            <div class="hidden sm:block">
                <span class="px-4 py-1 rounded-full border border-emerald-500/20 text-[10px] text-emerald-400 bg-emerald-500/5 uppercase tracking-widest">
                    Status: Online / Synced
                </span>
            </div>
        </div>
    </header>

    <main class="flex-grow flex flex-col overflow-hidden w-full max-w-5xl mx-auto p-2 md:p-6 mb-2 md:mb-6">
        <div class="flex-grow glass-panel shadow-2xl">
            <div id="chat-window" class="flex-grow overflow-y-auto p-4 md:p-10 space-y-8">
                <div id="welcome-screen" class="flex flex-col items-center justify-center text-center space-y-6 h-full min-h-[300px]">
                    <div class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-emerald-500/10 flex items-center justify-center float-icon">
                        <i class="fas fa-fingerprint text-emerald-400 text-2xl md:text-3xl"></i>
                    </div>
                    <div class="space-y-2">
                        <h2 class="text-white text-xl md:text-2xl font-semibold">Bienvenue dans la Guidance 2.0</h2>
                        <p class="text-slate-400 max-w-sm mx-auto text-xs md:text-sm leading-relaxed">
                            Interrogez les sources authentiques à travers une interface de nouvelle génération.
                        </p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-md">
                        <button onclick="quickAsk('Règles du jeûne')" class="p-3 text-[10px] md:text-xs bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-slate-300 transition-all">Règles du jeûne</button>
                        <button onclick="quickAsk('Piliers de l\'Islam')" class="p-3 text-[10px] md:text-xs bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-slate-300 transition-all">Piliers de l'Islam</button>
                    </div>
                </div>
            </div>

            <div class="p-4 md:p-6 bg-white/5 border-t border-white/10 backdrop-blur-md">
                <form id="qa-form" class="flex items-center gap-3 md:gap-4 max-w-4xl mx-auto">
                    <div class="relative flex-grow">
                        <input type="text" id="user-input" 
                            class="smart-input w-full py-3 md:py-4 pl-4 md:pl-6 pr-4 rounded-xl md:rounded-2xl text-white placeholder-slate-500 text-sm md:text-base"
                            placeholder="Votre question..." autocomplete="off" required>
                    </div>
                    <button type="submit" id="submit-btn" class="bg-emerald-500 hover:bg-emerald-400 text-slate-900 w-11 h-11 md:w-auto md:px-8 rounded-xl md:rounded-2xl font-bold transition-all flex items-center justify-center gap-2 shadow-lg shadow-emerald-500/20 flex-shrink-0">
                        <span class="hidden md:inline">Analyser</span>
                        <i class="fas fa-microchip"></i>
                    </button>
                </form>
                <div class="mt-3 md:mt-4 flex justify-center items-center gap-4 md:gap-6 opacity-40 text-[8px] md:text-[9px] text-slate-400 uppercase tracking-widest">
                    <span>Authenticity: High</span>
                    <span>Sources: Salaf Salih</span>
                    <span class="hidden xs:inline">AI Model: Gemini Flash</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        const apiKey = "AIzaSyBb0qShl7lZSluHfPPDVzfZpZrWZEucsQo";
        const chatWindow = document.getElementById('chat-window');
        const welcomeScreen = document.getElementById('welcome-screen');
        const qaForm = document.getElementById('qa-form');
        const userInput = document.getElementById('user-input');
        const submitBtn = document.getElementById('submit-btn');

        const systemPrompt = `Tu es un expert en jurisprudence islamique (Fiqh) et en croyance ('Aqida) suivant strictement la méthodologie des savants salafis, en particulier ceux d'Arabie Saoudite (Comité permanent de l'Ifta, Cheikh Ibn Baz, Cheikh Al-Othaymin, Cheikh Al-Fawzan, Cheikh Al-Albani).
        Règles de réponse :
        1. Utilise toujours le Coran et la Sunnah (avec l'authenticité des Hadiths selon les standards de l'Islam) comme preuves premières.
        2. Cite nommément les savants saoudiens ou les organismes officiels (Lajnah Da-imah) pour appuyer les fatwas.
        3. Réponds en français de manière claire, structurée et respectueuse.
        4. Preuves (Dalil) : TEXTE EN ARABE (vocalisé) puis sa traduction en français.
        5. Si une question porte sur un sujet de divergence, mentionne l'avis prépondérant (Râjih) selon les savants salafis.
        6. Ajoute toujours une conclusion rappelant qu'Allah est le plus savant (Allahou A'lam).
        7. Si la question n'a aucun rapport avec l'Islam, refuse poliment d'y répondre.`;

        async function callGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) { return null; }
        }

        function formatMessage(text) {
            let formatted = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/\*\*(.*?)\*\*/g, '<span class="text-emerald-400 font-bold">$1</span>')
                .replace(/\n/g, '<br>');
            
            formatted = formatted.replace(/([\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]+[\s\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]*)/g, '<span class="arabic-text">$1</span>');
            return formatted;
        }

        function appendMessage(text, isUser) {
            if (welcomeScreen && welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
            }
            
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-8 animate-in fade-in slide-in-from-bottom-4 duration-500`;
            
            const msg = document.createElement('div');
            msg.className = isUser 
                ? 'user-bubble px-5 py-3 md:px-6 md:py-4 max-w-[85%] md:max-w-[70%] text-sm font-medium'
                : 'bot-bubble px-5 py-5 md:px-6 md:py-5 max-w-[95%] text-sm md:text-base leading-relaxed';
            
            if (isUser) msg.innerHTML = text;
            else msg.innerHTML = `<div class="text-[9px] text-emerald-500/50 mb-3 font-bold uppercase tracking-widest">Calculated Guidance</div>${formatMessage(text)}`;
            
            wrapper.appendChild(msg);
            chatWindow.appendChild(wrapper);
            
            setTimeout(() => {
                chatWindow.scrollTo({
                    top: chatWindow.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        function quickAsk(q) {
            userInput.value = q;
            qaForm.dispatchEvent(new Event('submit'));
        }

        qaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const q = userInput.value.trim();
            if (!q) return;

            appendMessage(q, true);
            userInput.value = '';
            userInput.disabled = true;
            submitBtn.disabled = true;

            const loader = document.createElement('div');
            loader.id = 'loading';
            loader.className = 'flex items-center gap-3 text-emerald-400 text-[10px] md:text-xs mt-2 font-semibold tracking-widest';
            loader.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> INTERROGATION DE LA BASE DE DONNÉES...';
            chatWindow.appendChild(loader);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            const res = await callGemini(q);
            loader.remove();
            appendMessage(res || "CRITICAL ERROR: Data transmission failed.", false);

            userInput.disabled = false;
            submitBtn.disabled = false;
            userInput.focus();
        });

        // Service Worker basique pour permettre l'installation PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(() => {});
            });
        }
    </script>
</body>
</html>
